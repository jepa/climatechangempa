---
title: "SESYNC MPA and Climate Change DBEM Analysis"
author:
- "Juliano Palacios-Abrantes*^1,2^, Sarah M. Roberts^3^, Tim Cashion^4^, Talya ten
  Brink^5^,"
- William W.L. Cheung^1, Anne Mook^6^ and Tu Nguyen^7^
# date: "04/05/2018"
output: 
  html_document: 
    keep_md: yes
editor_options: 
  chunk_output_type: console
---

# Instructions

This markdown contains all of the code used to analyze the outputs from the DBEM and produce the results shown in the manuscript with the functions located in the `Functions` folder. 

To replicate the figures and results of the paper follow this steps:

1. Download the processed data at https://files.sesync.org/index.php/s/sWEi8z5EYnaojYM (you will need a password contact the main author or the editor) and move the folder to the repository's "Data" folder. Otherwise change the path to your own data-repository

2. Run the `setup`c *chunk* to load packages and functions needed. Note that this will install all of the packages that you have not installed. The functions will not be used now but they were used in previous steps. 
**Note:** make sure you change the `Data_Path` to where you downloaded the data

3. Go to the "4. Results" section an run the `FUN_ReadResults` *chunk* (4.1.1). This function is needed to read the datasets you just downloaded. You don't need to run `FUN_ggthemes` (4.1.2) unless you want to replicate the plots.

4. Run *chunk* `Load_Results` (4.2) to load all the data used in the paper.

5. Run the following *chunks* to get results, plot figures, run statistical analysis, and run sensitivity analysis:

**Note:** Chunks where `eval = F` will not work.



# 2. Pre-Analysis; Determine MPA percentage grid

```{r setup, eval = T, echo=T, warning=F,message=F, results = 'hide'}

#### READ ME !!! ####
# This chunk runs all the pkgs needed for the analysis
# Run this chunk before knit so you make sure you have all pkgs installed in R
# If you want to run it you will need to change the "path" of the DBEM_imp_F.R function

#### Set up packages ####

ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) 
    install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE)
}


#### Library ###
packages <- c(
  "dplyr", # Data manipulation
  "tidyr", # Data manipulation
  "ggpubr", #Nice grpahs and spatial analysis
  "cowplot", # For putting graphs in nice grids
  "knitr",
  "data.table",
  "rgdal", # Spatial analysis 
  "tools", # Spatial analysis 
  "sf", # Shapefile packages
  "broom", # for multiple statistics
  "moments", # for exploring normallity
  "wesanderson"
  )
moments::
ipak(packages)

# Functions needed to run the analysis
# source("./Functions/DBEM_imp.R")
# source("./Functions/rcp_summary.R")
# source("./Functions/DBEM_imp.R")
# source("./Functions/model_results.R")

Data_Path <- "Set your path"

```


```{r Grid_Analysis, eval=F, echo=T}

# Create dataset of MPAs to incorporate into the DBEM
# NOTE:
# grid_MPA_notake.csv <- was created using ARCGIS (SA) using the World Data base


# Data
grid_MPA_notake <- read.csv("/nfs/mpasandclimatechange-data/Data/MPA/grid_MPA_notake.csv")
# View(grid_MPA_notake)

# Formula in the DBEM
# x *(1-MPA_Index(i))

# Double check it make sense

FM = rnorm(259200,0.5,.1)

Check_Data <- grid_MPA_notake %>% 
  mutate(
    FM = FM,
    NoTakeProp = NoTakePercent/100,
    Test = round(FM * (1-NoTakeProp),2)
  ) %>% 
  filter(NoTakeProp > 0)

ggplot(Check_Data) +
  geom_tile(
    aes(
      x = Lon,
      y = Lat,
      colour = NoTakeProp,
      fill =NoTakeProp
    )
  ) +
  geom_sf(data = World_Land_sf,
          aes()
  ) + scale_colour_gradient2() +
  scale_fill_gradient2()


# Yes, makes sense! 

#  Creating datafile for DBEM (Computecanada)
MPA_Indexb <- grid_MPA_notake %>% 
  mutate(NoTakeProp = NoTakePercent/100) %>% 
  select(NoTakeProp)

write.csv(MPA_Indexb,
          "MPA_Indexb.txt",
          row.names = F
          )
```


# 3. Run Analysis

## Run SESYNC model on DBEM data

```{r Control_pannel, eval = F, echo=T}

# Load all data needed to run the routine

# Time frame
year_df <- tibble(year =  c(seq(1995,2014,1), seq(2041,2060,1), seq(2081,2100,1)),
                  time_period = c(rep("Today", 20), rep("Mid Century", 20), rep("End of Century", 20))
                  )


#Get list of species for analysis by comparing between MPA and Fish model species lists:
mpa_model_species <- data_frame(x = list.files("/nfs/mpasandclimatechange-data/Data/DBEM/MPA_Model/GFDL26"))
fish_model_species <- data_frame(x = list.files("/nfs/mpasandclimatechange-data/Data/DBEM/Fish_Model/GFDL26"))
exploited_species <- inner_join(mpa_model_species, fish_model_species)

# Spatialzied catch data (From SAU) (Pauly & Zeller, 2015)
country_species_catch_prop <- fread("/nfs/mpasandclimatechange-data/Data/Economics/CountrySpeciesCatchProp.csv")

# Price data (From FERU) (Tai et al., 2017, Sumaila et al. 2005)
prices <- fread("/nfs/mpasandclimatechange-data/Data/Economics/FERU_Price_Averaged.csv")

# Estimate who catches what for estimating price
country_prop_price <- left_join(country_species_catch_prop, prices) %>%
  rename(INDEX= cell_id) %>% 
  mutate(fishing_entity_id = as.character(fishing_entity_id),
         taxon_key = as.character(taxon_key),
         price = as.numeric(as.character(price)),
         price = if_else(is.na(price), 1496, price),
         weighted_price = price * prop,
         weighted_flexibility = flexibility * prop
  ) %>%
  group_by(INDEX, taxon_key) %>% 
  summarize(price = sum(weighted_price),
            flexibility = sum(weighted_flexibility)
  ) %>% 
  ungroup() 

# Load Lat long data of the world
Lon_Lat_DBEM <- fread("/nfs/mpasandclimatechange-data/Data/Lon_Lat_DBEM.txt",header = FALSE)
colnames(Lon_Lat_DBEM) <- c("INDEX","Longitude","Latitude")    

```


```{r main_routine, eval = F, echo = T}

# This chunk runs the model for each iteration (fish and MPA) and climate change (low and high) scenario

start <- Sys.time()
fish_26 <- model_results(Model="Fish", 
                         RCP="26",
                         species_list=exploited_species$x, 
                         GCM=NA, 
                         year_df=year_df, 
                         country_prop_price=country_prop_price)
end <- Sys.time()
fish26_time <- as.character(end-start)

start <- Sys.time()
fish_85 <- model_results(Model="Fish", 
                         RCP="85", 
                         species_list=exploited_species$x, 
                         GCM=NA, 
                         year=year_df, 
                         country_prop_price=country_prop_price) 
end <- Sys.time()
fish85_time <- as.character(end-start)
start <- Sys.time()
mpa_26 <- model_results(Model="MPA", 
                        RCP="26", 
                        species_list=exploited_species$x, 
                        GCM=NA, 
                        year=year_df, 
                        country_prop_price=country_prop_price)
end <- Sys.time()
mpa26_time <- as.character(end-start)
start <- Sys.time()
mpa_85 <- model_results(Model="MPA", 
                        RCP="85", 
                        species_list=exploited_species$x, 
                        GCM=NA, 
                        year=year_df, 
                        country_prop_price=country_prop_price) 
end <- Sys.time()
mpa85_time <- end-start

```

# 4. Results

## 4.1 Functions needed to get results

Load functions needed for analyzing results

### 4.1.1 `FUN_ReadResults`

This function simply reads the results in one single data frame

```{r FUN_ReadResults, eval = T, echo = T}

# This function loads the datasets depending on the model and RCP. 
# Note that path has to be changed once data is downloaed


Read_Results <- function(Model,RCP,Path="NA"){
  require(DT)
  require(dplyr)
  
  # If path changes
  if(Path == "NA"){
    File_Path <- Data_Path
  }else{
    File_Path <- Path
  }
  
  
  # For both models in once
  if(Model == "Both"){
    
    F_File <- paste("Fish_RCP",RCP,"_All_GCMs_20.csv", # include Wave_ for old results
                    sep="")
    
    M_File <- paste("MPA_RCP",RCP,"_All_GCMs_20.csv", # include Wave_ for old results
                    sep="")
    
    F_Data <- fread(paste(File_Path,F_File,
                          sep=""))
    
    M_Data <- fread(paste(File_Path,M_File,
                          sep=""))
    
    Both_Models <- F_Data %>% 
      bind_rows(M_Data) %>% 
      filter(time_period != "NA")
    
    return(Both_Models)
    
  }else{
    
    File <- paste(Model,"_RCP",RCP,".csv", 
                  sep="")
    
    Data <- fread(paste(File_Path,File,
                        sep=""))
    
    return(Data)
    
  }
  
}
```

### 4.1.2 `FUN_ggthemes`

This function standardizes `ggplot` themes among all plots

```{r FUN_ggtheme, eval =T, echo = T}


# Standarization of plots
ggtheme_Plot <- function() {
  theme(
    plot.title = element_text(size = rel(1), hjust = 0, face = "bold"),
    panel.background = element_blank(),
    strip.background = element_blank(),
    # strip.text       = element_text(size = base_size, face = "italic"),
    panel.border     = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    axis.ticks = element_blank(),
    axis.text.x = element_text(size = 18,
                               angle = 0,
                               face = "plain"),
    axis.text.y = element_text(size = 18),
    axis.title = element_text(size = 20),
    legend.key = element_rect(colour = NA, fill = NA),
    legend.position  = "top",
    legend.title = element_text(size = 16),
    legend.text = element_text(size = 14),
    strip.text.x = element_text(size = 18, colour = "darkgrey"),
    strip.text = element_text(size = 18)
  )
}

# Standarization of maps
ggtheme_Map <- function(base_size = 9, Region = "NA") {
  theme(
    # text             = element_text(#family = "Helvetica",color = "gray30", size = base_size),
    plot.title       = element_text(size = rel(1.25), hjust = 0, face = "bold"),
    panel.background = element_blank(),
    panel.border     = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(color = "transparent"),
    strip.background =element_rect(fill = "transparent"),
    strip.text.x = element_text(size = 18, colour = "black",face= "bold", angle = 0),
    axis.line        = element_blank(), # element_line(colour = "grey30", size = .5))
    axis.ticks       = element_blank(),
    axis.text        = element_blank(),
    axis.title       = element_blank(),
    legend.key       = element_rect(colour = NA, fill = NA, size = 4),
    legend.position = "bottom",
    legend.key.width = unit(5,"line"),
    legend.title = element_text(size = 22, colour =),
    legend.text = element_text(size = 20)
  )
}
```

## 4.2 Load Data and Results

```{r Load_Results, eval = F, echo = T}

# Data needed for the analysis

# ---------------- #
# Spatial Data 
# ---------------- #

# Latitude and Longitude grid
Lon_Lat_DBEM <- fread(paste(Data_Path,"Lon_Lat_DBEM.txt", sep=""),header = FALSE)
colnames(Lon_Lat_DBEM) <- c("INDEX","Longitude","Latitude")   

# ----------------  #
# World land polyon for maps
# Note: this data is only used for visual purposes not on the repository but it can be downloaded from https://www.naturalearthdata.com/ or use the r package
# ------------------- #

# The path
path_world <- "/nfs/mpasandclimatechange-data/Data/Spatial_Data/World_Land"

# File name
file_name <- "TM_WORLD_BORDERS"

#Load it!
World_Land_sf <- st_read(dsn = path_world, 
                         layer = file_path_sans_ext(file_name)
)

# Base plot
World_Map <- ggplot(World_Land_sf) +
  geom_sf()


# ----------------  #
# MPA shapefile
# ----------------  #

path_MPA <- paste(Data_Path,"MPA", sep="")

# File name
MPA_file_name <- "CM_noTake"

#Load it!
MPA_sf <- st_read(dsn = path_MPA, 
                         layer = file_path_sans_ext(MPA_file_name)
                  ) %>% 
  st_transform(crs = "+proj=eck4")


# head(MPA_sf)
# ggplot(MPA_sf) +
#   geom_sf()


# ----------------  #
# MPA data
# ----------------  #

# MPA touching grid dataset (0= no MPA, 1=MPA, 2=touching)"
MPA_Grid <- fread("/nfs/mpasandclimatechange-data/Data/MPA/grid_MPA_touching.csv",header = TRUE) %>% 
  rename(INDEX = Seq) %>% 
  dplyr::select(-Lon,-Lat)

# MPA grid to match autocorrelation
MPA_Grid_autocor <- fread("/nfs/mpasandclimatechange-data/Data/MPA/MPA_Grid_june2020.csv",header = TRUE) %>%
  dplyr::select(lon,lat,touching,DIST_M) %>% 
  janitor::clean_names()

### Nake data for paper supplements

MPA_Grid %>% 
  group_by(NAME,DESIG_ENG,IUCN_CAT,MARINE,NO_TAKE,PARENT_ISO,ISO3) %>% 
  summarise(n=n()) %>% 
  select(-n) %>% 
  readr::write_csv("~/SESYNC/data/Global Paper/Submission_GCB/Supplements/MPA_List.csv")

# Transform PA grid to sf
mpa_map <- MPA_Grid %>% 
  left_join(Lon_Lat_DBEM) %>% 
  filter(Touching != 0) %>% 
  mutate(Touching = ifelse(Touching == 1, "MPA","Surrounding")) %>% 
  st_as_sf(.,coords = c("Longitude", "Latitude")) %>%
  st_set_crs(4326) %>% # to match shapefiles
  st_transform("+proj=eck4") # cylindrical projection!!!!

# Basin Biome from Gabriel's (2017) book chapter
Basin_biome_comp <- fread("/nfs/mpasandclimatechange-data/Data/basin_biome.csv",header = TRUE) %>%
  janitor::clean_names()

# biome2 1 = Coastal tropical 
# biome2 2 = Coastal sub-tropical
# biome2 3 = Coastal polar
# biome2 4 = Oceanic tropical
# biome2 5 = Oceanic sub-tropical
# biome2 6 = Oceanic polar

# Autocorrelated basin biome
Basin_biome <- fread("/nfs/mpasandclimatechange-data/Data/basin_biome.csv",header = TRUE) %>%
  janitor::clean_names() %>% 
  mutate_at(vars(lon,lat),round) %>%
  mutate(
  lat = ifelse(lat < 0, lat + 1/2, lat - 1/2),
  lon = ifelse(lon < 0, lon + 1/2, lon - 1/2)
  ) %>%
  group_by(lat,lon,basin,basin2,bgcp,biome,biome2) %>% 
  summarise(total = n()) %>% 
  filter(!is.na(biome)) %>% 
  ungroup() %>% 
  select(lat,lon,biome2)


# Transform  basin biome to map
Basin_biome_map = st_as_sf(Basin_biome,
                           coords = c("lon", "lat")
) %>%
  st_set_crs(4326) %>% # to match shapefiles
  st_transform("+proj=eck4")

# ---------------- #
# SESYNC-DBEM Data 
# ---------------- #

# Fish and MPA model for RCP 2.6
Both_Models26 <- Read_Results("Both","26",Data_Path) %>% 
  mutate(RCP = as.character(RCP))

# Fish and MPA model for RCP 8.5
Both_Models85 <- Read_Results("Both","85",Data_Path) %>% 
  mutate(RCP = as.character(RCP))

# Join both models in one dataset for analyzing

### First, filter out regions where data is allways 0 (A.k.A land where we have no species)
NoData <- Both_Models85  %>% 
  bind_rows(Both_Models26) %>% 
  group_by(INDEX) %>% 
  summarise(sum= sum(total)) %>% 
  filter(sum == 0) %>% 
  pull(INDEX)

#### Then, join models and filter out those regions where no spp. were evaluated
All_Models <- Both_Models85  %>% 
  bind_rows(Both_Models26) %>% 
  # This is needed to remove cells that are zeros and actually have no fish data
  filter(!INDEX %in% NoData) %>% 
  select(-n)

# Path for saving results (Note that we have ./Figures for figures)
Result_Path <- "./data/Data/Results"


```


# 5. Paper Figures

## Fig. 1 -Delta time just for MPA

Figure 1. Change in biomass under climate change, incorporating current no-take MPAs.** Results for mid century (2041-2060) relative to present (1995-2014) under a high emission scenario (RCP 8.5). Results from the MPA model with MPAs included in this study outlined in black.

```{r Fig_one__Data, eval = F, echo = T}

Delta_Time <- All_Models %>% 
  spread(time_period,total) %>% 
  mutate_at(vars(`Mid Century`, # Estimate percentage differences
                 `End of Century`),
            funs(ifelse(Today == 0 & . == 0, 0, # If no change than 0
                        ifelse(Today == 0 & . > 0, 100, # If changes from 0 to anything then 100
                               ((.-Today)/((.+Today)/2))*100 # Estimate percentage differences
                        )
            )
            )
  ) %>% 
  gather("time_period","MCP_Chng",`Mid Century`,`End of Century`) %>% 
  select(-Today) %>%
  mutate(
    MCP_Chng = ifelse(is.na(MCP_Chng), 0, MCP_Chng), 
    Per = ifelse(MCP_Chng <= -25, -25,
                 ifelse(MCP_Chng >= 25, 25,MCP_Chng) # Just to set the percentage bounds
    )
  ) %>% 
  filter(Measure == "Mean") %>% 
  left_join(MPA_Grid,
            by = "INDEX")

# Convert data for projected shapefile
Delta_time_map <- Delta_Time %>% 
  filter(Model == "MPA" & Data_Type == "Abd" & time_period == "Mid Century",RCP == 85)

Delta_time_map <- st_as_sf(Delta_time_map,
                           coords = c("Longitude", "Latitude")
) %>%
  st_set_crs(4326) %>% # to match shapefiles
  st_transform("+proj=eck4")

```


```{r Figure_One_plot, eval = F, echo = T}

# Plot map
ggplot() +
  geom_sf(data = Delta_time_map, aes(colour = Per)) +
  geom_sf(data = World_Land_sf, colour = "grey50", fill = "grey50") +
  geom_sf(data = MPA_sf, colour = "black", fill = NA, size = 0.5) +
  scale_colour_gradient2("Percentage Change in Biomass (%)",
                       labels = c("<-25",seq(-20,20,5),">25"),
                       breaks = c(seq(-25,25,5)),
                       na.value = "grey90"
                       ) +
  ggtheme_Map() +
  guides(fill = guide_legend(title.position = "top",
                             label.position = "bottom",
                             title.hjust = 0.5,
                             nrow = 1,
                             byrow = TRUE)
  ) +
  ggsave(
    width = 14,
    height = 7,
    units = "in",
    # filename = "Figure_1_20_NewB.png",
    # path= "./data/Global Paper/Paper_Results"
    # Path and name for submission
    filename = "Figure1N.png",
    path= "./data/Global Paper/Submission_GCB/Figures"
  )

```

## Fig. 2. Boxplot changes over time MPA

Fig. 2. Percentage change of biomass within regions containing MPAs and in surrounding waters relative to today.** Whiskers represent 1.5* interquartile range. Box represents interquartile range as distance between first and third quartiles. Line represents median, and black points represent outliers (outside of 1.5*IQR)

### Prepare data figure 2

```{r Fig_two_data, eval = F, echo = T}

Delta_Time_MPA <- All_Models %>% 
  filter(
    Measure == "Mean",
    Model == "MPA",
    Data_Type %in% c("Abd"),
  ) %>% 
  spread(time_period,total) %>% 
  mutate_at(vars(`Mid Century`, # Estimate percentage difference
                 `End of Century`),
            funs(ifelse(Today == 0 & . == 0, 0, # If for no difference than 0
                        ifelse(Today == 0 & . > 0, 100, # If changes from 0 to anything then 100
                               ((.-Today)/((.+Today)/2))*100 # Estimate percentage difference
                        )
            )
            )
  ) %>% 
  gather("time_period","MCP_Chng",`Mid Century`,`End of Century`) %>% 
  select(-Today) %>% 
  left_join(MPA_Grid,
            by = "INDEX") %>% 
  mutate(Per = ifelse(MCP_Chng <= -25, -25,
                      ifelse(MCP_Chng >= 25, 25,MCP_Chng) # Just to set the percentage bounds
  ),
  Touching = ifelse(Touching==1, "MPA",
                    ifelse(Touching==2, "Surrounding",
                           NA
                    )
  ),
  RCP = ifelse(RCP== 26,"Low","High"),
  time_period = ifelse(time_period== "End of Century","B","A"),
  Order = ifelse(RCP == "Low",1,2)
  ) %>% 
  filter(!is.na(Touching))

```

### Plot figure 2

```{r Fig_two_plot, eval = F, echo = T}

ggplot(Delta_Time_MPA,
       aes(
         x = reorder(RCP,Order),
         y = Per,
         fill = Touching
       )
) +
  geom_boxplot() +
  scale_color_manual("Region", 
                     values = wes_palette("Darjeeling2")
  ) +
  scale_fill_manual("Region", 
                    values = wes_palette("Darjeeling2"),
  ) +
  scale_y_continuous("Percentage Change\n(Relative to Today)",
                     labels = c("<-25",seq(-20,20,5),">25"),
                     breaks = c(seq(-25,25,5))) +
  labs(x = "Emission Scenario") + 
  ggtheme_Plot() +
  theme(legend.position = "right",
        strip.background = element_blank(),
        strip.text.x = element_text(size = 18, colour = "black", face = "bold")
  ) +
  facet_wrap(~ time_period,
             labeller=as_labeller(c(
               "B" = "End of Century",
               "A" = "Mid Century"))
  ) +
  ggsave(
    width = 13,
    height = 10,
    units = "in",
    filename = "Figure2.png",
    path= "./data/Global Paper/Submission/Figures"
  )

```

## Fig. 3. - Biome level box plots

```{r Figure_2n, eval = F, echo = T}

# Biome Boxes
Biome_box <- Delta_Time_MPA %>% 
  rename(lat = Latitude,
         lon = Longitude) %>% 
  left_join(Basin_biome_comp,
            by = c("lon", "lat")
  ) %>% 
  filter(!is.na(biome2)) %>% 
  mutate(
    biome2 = ifelse(biome2 == 5 & lat < 0, 5.1,
                    ifelse(biome2 == 6 & lat < 0, 6.1,
                           ifelse(biome2 == 2 & lat < 0, 2.1,
                                  ifelse(biome2 == 3 & lat < 0, 3.1,biome2))))
  ) %>% 
  select(INDEX,lon,lat,RCP,time_period,Per,Touching,biome2) %>% 
  # gather("time","value",time_period,Per) %>% 
  mutate(label = paste(time_period,RCP,sep="_"))

# Make plot of all boxes to eddit later
ggplot(data = Biome_box,
       aes(
         x = label,
         y = Per,
         fill = Touching
       )
       ) +
  # geom_violin() +
  geom_boxplot(outlier.colour = "red", 
       outlier.shape = 1,
       outlier.alpha = 0.1) +
  # geom_hline(aes(yintercept = 0), linetype = "dashed", color = "grey50") +
  scale_color_manual("Region", 
                     values = wes_palette("Darjeeling2")
  ) +
  scale_fill_manual("Region", 
                    values = wes_palette("Darjeeling2"),
  ) +
  scale_y_continuous("",
                     labels = c("<-50",0,">50"),
                     breaks = c(seq(-50,50,50))
                     ) +
  labs(x = "") + 
  ggtheme_Plot() +
  theme(legend.position = "") +
  facet_wrap(~biome2)

# ------------------ #
# Create biome map
# ------------------ #

# Personalized palet
my_palet <- c(
  wes_palette("Darjeeling1")[3], # Coastal tropical (yes)
  wes_palette("Zissou1")[3], # Coastal template (yes) 
  wes_palette("FantasticFox1")[1], # ? Coastal Polar (yes)
  wes_palette("GrandBudapest2")[3], # Oceanic Tropical (yes)
  wes_palette("GrandBudapest2")[2], # Oceanic Temperate  (yes)
  wes_palette("GrandBudapest2")[4], # Oceanic Polar  (yes)
  wes_palette("Darjeeling2")[1], # MPA (yes)
  wes_palette("Darjeeling2")[2] # Surrounding) (yes)
)

# Map with regions
ggplot() +
  geom_sf(data = Basin_biome_map, aes(colour = as.character(biome2)),size=2) +
  geom_sf(data = mpa_map, aes(colour = as.character(Touching)),size=0.4) +
  geom_sf(data = World_Land_sf,aes(),color = "grey",size=0.1) +
  scale_color_manual("Region", 
                     values = my_palet
                     ) +
  ggtheme_Map() +
  ggsave(plot = last_plot(),
         filename = "./data/Global Paper/Submission_GCB/Figures/Figure3_map.png",
         height = 15,
         width = 18,
         units = "in")

```




## Fig. 4. - Differences Map

Fig. 3.  Biomass (A) and revenue (B) differences between the MPA and the no-MPA scenarios.** Results for mid century (2041-2060) under high emission scenario (RCP 8.5) within MPA and surrounding cells up to 7.5 decimal degrees (~825 km) from an MPA border representing 99% of the cumulative distribution. Density plots (C) represent the average difference between the MPA and no-MPA models aggregated by latitude (frequency of values from <-25% to >25%) in all areas, waters containing MPAs, surrounding waters, and unprotected water.

### Prepare data figure 4

```{r Figure_three_Data, eval = F, echo = T}

# ---------------------- #
# Delta Models data (Map)
# ---------------------- #

Results_Data <- All_Models %>% 
  filter(Data_Type %in% c("Abd","revenue"),
         Measure == "Mean",
         RCP == 85
  ) %>% 
  spread("Model","total") %>% 
  mutate(
    MPA = ifelse(is.na(MPA), 0, MPA), # I believe there are parts that MPA model does not have?
    Fish = ifelse(is.na(Fish), 0, Fish),
    Diff_Models = ifelse(MPA == 0 & Fish == 0, 0, # If MPA and Fish are zero, then no difference
                         ifelse(MPA == 0 & Fish > 0, -100, # If MPA is zero but Fish >0 then -100 
                                ifelse(MPA > 0 & Fish == 0, 100, # If MPA > 0 but Fish = 0, then +100
                                       (MPA-Fish)/(MPA)*100 # Estimate percentage change
                                )
                         )
    ),
    # Just to set the percentage bounds
    Per = ifelse(Diff_Models <= -25, -25,
                 ifelse(Diff_Models >= 25, 25,Diff_Models)
    ),
    # For plot labels
    Data_Type = ifelse(Data_Type == "Abd", "Biomass", "Revenue")
  ) %>% 
  left_join(MPA_Grid,
            by = "INDEX") %>% 
  mutate(
    Touching_b = ifelse(Touching == 0,"Unprotected",
                        ifelse(Touching == 1, "MPA",
                               ifelse(Touching == 2, "Surrounding",
                                      NA
                               )
                        )
    )
  )

# Transform data to sf
Results_Data_map <- st_as_sf(Results_Data,
                           coords = c("Longitude", "Latitude")
) %>%
  st_set_crs(4326) %>% # to match shapefiles
  st_transform("+proj=eck4")


# Exploring the dataset
# head(Results_Data)
# unique(Results_Data$Touching)
# unique(Results_Data$time_period)
# unique(Results_Data$MPApresentNoTake)
# hist(Results_Data$Diff_Models)

# unique(Results_Data$Touching)
# unique(Results_Data$Geo_Region)

# Some NA's... 
# Results_Data %>% 
  # filter(is.na(MPA)C)

# Plot them... 

# Results_Data %>% 
#   filter(is.na(MPA)) %>% 
#   ggplot()+
#   geom_tile(
#     aes(
#       x = Longitude,
#       y = Latitude,
#       fill = Per
#     )
#   )

### Revenue increase spillover

# ---------------------- #
# Spillover data (histograms)
# ---------------------- #

Spillover_diff_Lat <- Results_Data %>% 
  group_by(Latitude, time_period, RCP,Measure,Data_Type, Touching_b) %>% 
  summarize(total_value = mean(Diff_Models), #mean percent change
            n_cells = n(),
            rate = total_value/n_cells) %>%  # everything below or over 100 is 100
  mutate(total_value  = ifelse(total_value >= 100,100,
                                ifelse(total_value <= -100,-100,total_value))
         ) %>% 
  group_by(time_period,RCP,Measure,Data_Type,Touching_b) %>% 
    mutate(RMean = zoo::rollmean(x = total_value, 
                            10, 
                            align = "right", 
                            fill = total_value)
    )

Spillover_diff_Lat$total_value <- Spillover_diff_Lat$total_value %>% 
  replace_na(0)


 Spillover_diff_Lat_1 <- Results_Data %>% 
  group_by(Latitude, time_period, RCP,Measure,Data_Type) %>% 
  summarize(total_value = mean(Diff_Models), #mean percent change
            n_cells = n(),
            rate = total_value/n_cells) %>% # everything below or over 100 is 100
   mutate(total_value  = ifelse(total_value >= 100,100,
                                ifelse(total_value <= -100,-100,total_value))
         ) %>% 
  group_by(time_period,RCP,Measure,Data_Type) %>% 
    mutate(RMean = zoo::rollmean(x = total_value, 
                            10, 
                            align = "right", 
                            fill = total_value)
    )

Spillover_diff_Lat_1$total_value <- Spillover_diff_Lat_1$total_value %>% 
  replace_na(0)

```

### Plot figure 4

```{r Fig_three_plot, eval = F, echo = T}

# --------------------- #
# Create maps (A and B)
# --------------------- #

Map_Abd <- Results_Data_map %>% 
  filter(
    Data_Type == "Biomass" & time_period == "Mid Century"
  ) %>% 
  ggplot() +
  geom_sf(aes(color = Per)) +
  geom_sf(data = World_Land_sf, colour = "grey50", fill = "grey50") +
  scale_colour_gradient2("Change realtive to present (%)",
                         labels = c("<-25",seq(-20,20,5),">25"),
                         breaks = c(seq(-25,25,5)),
                         na.value = "grey90"
  ) +
  ggtheme_Map() +
  theme(legend.position = "")


# Revenue Map

Map_Rev <- Results_Data_map %>% 
  filter(
    Data_Type == "Revenue" & time_period == "Mid Century"
  ) %>% 
  ggplot() +
  geom_sf(aes(color = Per)) +
  geom_sf(data = World_Land_sf, colour = "grey50", fill = "grey50") +
  scale_colour_gradient2("Change realtive to present (%)",
                         labels = c("<-25",seq(-20,20,5),">25"),
                         breaks = c(seq(-25,25,5)),
                         na.value = "grey90"
  ) +
  ggtheme_Map() +
  theme(legend.position = "")+
  ggtheme_Map() +
  guides(fill = guide_legend(title.position = "top",
                             label.position = "bottom",
                             title.hjust = 0.5,
                             nrow = 1,
                             byrow = TRUE)
  )


# Get legend for cowplot
legend_map <- get_legend(Map_Rev)

# Re-plot without legend
Map_Rev <- Map_Rev +
  theme(legend.position = "")

# Abundance Histogram (No Latitudinal differentiation)]

Hist_Abd <- ggplot() + 
  geom_path(data = subset(Spillover_diff_Lat, Data_Type == "Biomass" & time_period == "Mid Century"), 
            aes(y=Latitude, 
                x=RMean, 
                color=Touching_b),
            size = 1) +
  geom_path(data = subset(Spillover_diff_Lat_1, Data_Type == "Biomass"),
            aes(y=Latitude, 
                x=RMean, 
                color = "Total"),
            size = 1
            ) +
  scale_color_manual(values = wes_palette("Darjeeling2")) +
  scale_x_continuous(
    limits = c(0,80),
    breaks = c(0,50),
    labels =c("0",">50")
    ) +
  # scale_color_manual(values=c("dodgerblue3", "firebrick3", "black", "seagreen3"))+
  ggtheme_Plot() +
  labs(x = "",
       y = "") +
  theme(
  axis.text.y = element_blank(),
  legend.position = "",
  legend.key.width = unit(2,"line"),
  legend.title = element_text(size = 22),
  legend.text = element_text(size = 20)
  ) +
  geom_vline(xintercept = 0, colour = "black", linetype = "dotted"); Hist_Abd


Hist_Rev <- ggplot() + 
  geom_path(data = subset(Spillover_diff_Lat, Data_Type == "Revenue" & time_period == "Mid Century"), 
            aes(y=Latitude, 
                x=RMean, 
                color=Touching_b),
            size = 1)  +
  geom_path(data = subset(Spillover_diff_Lat_1, Data_Type == "Revenue"),
            aes(y=Latitude, 
                x=RMean, 
                color = "Total"), 
            # linetype = "dotted",
            size = 1) +
  geom_vline(xintercept = 0, colour = "black",linetype = "dotted") +
  scale_color_manual("Spillover effect by latitude",
                     values = wes_palette("Darjeeling2")
  ) +
  scale_x_continuous(breaks = c(-100,0,50),
                     labels =c(">-100",0,">50")) +
  # scale_color_manual(values=c("dodgerblue3",
  #                             "firebrick3",
  #                             "black",
  # "seagreen3"))+
  ggtheme_Plot() +
  labs(x = "",
       y = "") +
  theme(
    axis.text.y = element_blank(),
    legend.position = "bottom",
    legend.title = element_text(size = 22),
    legend.text = element_text(size = 20)
  ) +
  guides(color = guide_legend(title.position = "top",
                              label.position = "right",
                              title.hjust = 0.5,
                              nrow = 1,
                              byrow = TRUE)
  );Hist_Rev

# Get legend for cowplot
legend_hist <- get_legend(Hist_Rev)

# Re-plot without legend
Hist_Rev <- Hist_Rev +
  theme(legend.position = "")

# Plot them all

plot <- ggdraw() +
  # Abundance
  draw_plot(Map_Abd, x = 0, y = 0.6, width = 0.6, height = 0.4) +
  draw_plot(Hist_Abd, x = 0.59, y = 0.59, width = 0.3, height = 0.4) +
  # Revenue
  draw_plot(Map_Rev, x = 0, y = 0.2, width = 0.6, height = 0.4) +
  draw_plot(Hist_Rev, x = 0.57, y = 0.19, width = 0.3, height = 0.4) +
  # Legends
  draw_plot(legend_map, x = 0, y = 0.1, width = 0.59, height = 0.1) +
  draw_plot(legend_hist, x = 0.60, y = 0.1, width = 0.3, height = 0.1) +
  # Labeks
  draw_plot_label(label = c("A", "B", "C"), 
                  size = 30,
                  x = c(0.0, 0.0, 0.56), 
                  y = c(1, 0.6, 1)
  ) +
  # Uncomment for latitudinal version 
  draw_plot_label(label = c("Revenue", "Biomass"),
                  size = 40,
                  x = c(0.91, 0.91),
                  y = c(0.50, 1),
                  angle = 270,
                  colour = "black"
  )

# Path and name for submission
# Save plot 
save_plot("./data/Global Paper/Submission_GCB/Figures/Figure4N.png",
          plot,
          base_height = 15,
          base_width = 20)


```

# 6. Paper Statistics

We are going to determine the statistical significance of differences between the models (fish/mpa) and time frames (present/future) using a t.test or Wilcox test.

## 6.1 Test assumptions

First we tested for normality by estimating the data skewness and kurtosis. Results show that our results are highly skewed with a sharp peak. Hence we carried out a non-parametric tests.

```{r Test_for_normallity, eval = F, echo = T}

Stats_Data <- All_Models %>% 
  spread("Model","total") %>% 
  mutate(INDEX = as.character(INDEX),
         MPA = ifelse(is.na(MPA), 0, MPA),
         Fish = ifelse(is.na(Fish), 0, Fish)
  ) %>% 
  left_join(MPA_Grid,
            by= "INDEX") %>%  # 1 mpa ; 2 touching
  filter(RCP == 85,
         Measure == "Mean",
         ! Data_Type %in% c("flexibility","nonuse_value"),
         !is.na(Touching)
  )

### Data Histogram

# Fish Model (Not-Normall distribution)
Stats_Data %>% 
  ggplot() +
  geom_histogram(
    aes(
     Fish
    ),
    binwidth = 50
  ) +
  facet_wrap(~Touching)


# MPA Model (Not-Normall distribution)
Stats_Data %>% 
  ggplot() +
  geom_histogram(
    aes(
     MPA
    ),
    binwidth = 50
  ) +
  facet_wrap(~Touching)

### Skewness and  Kurtosis
# S = 0, Perfect; 0-0.5 aprox; 0.5-1 moderate skew; > 5 very skewed

# For MPA (Most of them skewed)
Stats_Data %>% 
  filter(time_period == "Mid Century") %>% 
  group_by(time_period,
           Data_Type,
           Touching) %>% 
  # Uses broom to estimate sig.dif with wilcox for each group_by
  do(Skew = skewness(.$MPA)
  ) %>% 
  tidy(Skew)


# For Fish (Most of them skewed)
Stats_Data %>% 
  filter(time_period == "Mid Century") %>% 
  group_by(time_period,
           Data_Type,
           Touching) %>% 
  # Uses broom to estimate sig.dif with wilcox for each group_by
  do(Skew = skewness(.$Fish)
  ) %>% 
  tidy(Skew)

# K = 3 stndr normal dist; k > 3 sharper peak High K; k < 3 flatter peak low K

# For MPA (All of them leptokurtic)
Stats_Data %>% 
  filter(time_period == "Mid Century") %>% 
  group_by(time_period,
           Data_Type,
           Touching) %>% 
  # Uses broom to estimate sig.dif with wilcox for each group_by
  do(Kurt = kurtosis(.$MPA)
  ) %>% 
  tidy(Kurt)


# For Fish (All of them leptokurtic)
Stats_Data %>% 
  filter(time_period == "Mid Century") %>% 
  group_by(time_period,
           Data_Type,
           Touching) %>% 
  # Uses broom to estimate sig.dif with wilcox for each group_by
  do(Kurt = kurtosis(.$Fish)
  ) %>% 
  tidy(Kurt)

### Test for Normality (qqnorm)
# Fish Model

qqnorm(Stats_Data$Fish) # Not really normally dist.
# MPA Model
qqnorm(Stats_Data$MPA) # Not really normally dist.

```

## 6.2 Addressing spatial auto-correlation

This is the method to estimate the length of the spatial auto-correlation in our data by computing the Moran’s Index of spatial auto-correlation with a variogram
https://www.flutterbys.com.au/stats/tut/tut8.4a.html

### Estimating spatial auto-correlation


```{r, spatial_auto, eval = T, echo = F}

# Data
Autocor <- All_Models %>% 
  mutate(total = ifelse(is.na(total), 0, total)) %>%
  filter(
    time_period == "Today",
    Data_Type == "Abd",
    Measure == "Mean",
    RCP == 26,
    Model == "MPA") %>% 
  left_join(MPA_Grid) %>%
  filter(Touching == 0,
         Longitude < -97 | Longitude > 130,
         Latitude > 0
  ) %>% 
  dplyr::select(INDEX,Longitude,Latitude,total)

# Run multiple interations of the analysis

for(i in 1:100){
  
  Ran_Samp <- sample(Autocor$INDEX,5000)
  
  Autocor_test <- Autocor %>% 
    filter(INDEX %in% Ran_Samp)
  
  data.spatialCor.gls <- nlme::gls(Latitude~Longitude, Autocor_test, method = "REML")
  
  
  var <- nlme:::Variogram(data.spatialCor.gls, form = ~Latitude + Longitude, resType = "normalized") %>% 
    mutate(run = i) %>% 
    rowid_to_column("index")
  
  # plot(var)
  
  if(i == 1){
    partial <- var
  }else{
    partial <- bind_rows(partial,var)
  }
  
}


# Get average of all 100 runs
means_data <- partial %>%
  group_by(index) %>% 
  summarise_all(c(
    mean=mean,
    sd= sd)
  )

# Get the data for all
plot_data <- means_data %>% 
  dplyr::select(
    variog = variog_mean,
    dist = dist_mean,
    npairs= n.pairs_mean
  )

```

### Fixing data for auto-corrrelation

```{r, spatial_auto, eval = T, echo = F}

library("raster")
#it looks like the aggregate function is doing what we actually want (which is aggregating to 1x1 degree cells. Focal statistics is actually just smoothing things out)

# Test function
test <- All_Models %>% 
  filter(
    time_period == "Today",
    # Data_Type == "Abd",
    Measure == "Mean",
    # RCP == 26,
    Model == "MPA") %>% 
  dplyr::select(INDEX,Longitude,Latitude,total) %>% 
  arrange(INDEX)

#this is the part that would need to go in a for loop or something
coordinates(test) <- ~Longitude+Latitude 
gridded(test) <- TRUE


r <- raster(test, "total")
r_2 <- aggregate(r, 2, fun=mean, na.rm=T, expand=F)

#make dataframe
test_3 <- as.data.frame(r_2, xy=TRUE)
test_3 <- test_3[complete.cases(test_3),]

# Plot data to see how it looks like
# 
# ggplot(test_3) +
#   geom_tile(
#     aes(
#       x = x,
#       y = y,
#       fill = total
#     )
#   )
# 

# Since its only one deg* one deg, we can simply round the coords and group by them
autocor_data <- All_Models %>%
  left_join(MPA_Grid,
            by = "INDEX") %>% 
  mutate(
    Region = ifelse(Touching==2, "Surrounding",
                    ifelse(Touching==1, "MPA",
                           "Open")
    )
  ) %>% 
  mutate_at(vars(Longitude,Latitude),round) %>%
  mutate(
    lat = ifelse(Latitude < 0, Latitude + 1/2, Latitude - 1/2),
    lon = ifelse(Longitude < 0, Longitude + 1/2, Longitude - 1/2)
  ) %>%
  group_by(time_period,Data_Type,Measure,RCP,Model,Region,lon,lat) %>%
  summarise(total = mean(total,na.rm=T)
  )

# Plot to compare two methids match

# autocor_data %>% 
#   filter(
#     time_period == "Today",
#     Data_Type == "Abd",
#     Measure == "Mean",
#     RCP == 26,
#     Model == "MPA") %>% 
#   ggplot() +
#   geom_tile(
#     aes(
#       x = lon,
#       y = lat,
#       fill = total
#     )
#   ) +
#   facet_wrap(~Region)


# Use this data for statistical analysis
write.csv(
  autocor_data,
  "/nfs/mpasandclimatechange-data/Global Paper/Paper_Results/All_models_autocor.csv",
  row.names = F
)

```


## 6.3 Comparisons between time-periods (Chi-squeare approach)

<!-- Chi-squeare  -->
<!-- https://www.statisticshowto.com/probability-and-statistics/chi-square/ -->

<!-- A very small chi square test statistic means that your observed data fits your expected data extremely well. In other words, there is a relationship. -->

<!-- A low value for chi-square means there is a high correlation between your two sets of data. In theory, if your observed and expected values were equal (“no difference”) then chi-square would be zero — an event that is unlikely to happen in real life. Deciding whether a chi-square test statistic is large enough to indicate a statistically significant difference isn’t as easy it seems. It would be nice if we could say a chi-square test statistic >10 means a difference, but unfortunately that isn’t the case. -->

<!-- For a Chi-square test, a p-value that is less than or equal to your significance level indicates there is sufficient evidence to conclude that the **observed distribution is not the same as the expected distribution**. You can conclude that a relationship exists between the categorical variables. -->

```{r chi_time_periods, eval = T, echo = F}

# Main Data preparation

# biome2 1 = Coastal tropical 
# biome2 2 = Coastal sub-tropical
# biome2 3 = Coastal polar
# biome2 4 = Oceanic tropical
# biome2 5 = Oceanic sub-tropical
# biome2 6 = Oceanic polar

Delta_Time_chi <- autocor_data %>% 
  filter(Model == "MPA",
         Measure == "Mean",
         Data_Type %in% c("Abd")
  ) %>% 
  spread(time_period,total) %>% 
  mutate_at(vars(`Mid Century`, # Estimate percentage change
                 `End of Century`),
            funs(ifelse(Today == 0 & . == 0, 0, # If for no change than 0
                        ifelse(Today == 0 & . > 0, 100, # If changes from 0 to anything then 100
                               # ./Today
                               # ((.-Today)/((.+Today)/2))*100 # Estimate percentage change
                               (.-Today)/(Today)*100 # Estimate percentage change
                        )
            )
            )
  ) %>% 
  gather("time_period","MCP_Chng",`Mid Century`,`End of Century`) %>% 
  dplyr::select(-Today) %>% 
  left_join(
    Basin_biome,
    by = c("lat","lon")
  ) %>% 
  mutate(
    Outcome = ifelse(MCP_Chng  >= 0, "Positive","Negative"),
    biome = ifelse(biome2 == 1, "C_Tropical",
                   ifelse(biome2 == 2 & lat > 0,"C_Temperate_N",
                          ifelse(biome2 == 2 & lat < 0, "C_Temperate_S",
                                 ifelse(biome2 == 3 & lat > 0, "C_Polar_N",
                                        ifelse(biome2 == 3 & lat < 0,"C_Polar_S",
                                               ifelse(biome2 == 4, "O_Tropical",
                                                      ifelse(biome2 == 5 & lat > 0, "O_Temperate_N",
                                                             ifelse(biome2 == 5 & lat < 0,"O_Temperate_S",
                                                                    ifelse(biome2 == 6 & lat > 0, "O_Polar_N",
                                                                           ifelse(biome2 == 6 & lat < 0, "O_Polar_S", NA))))))))))
  ) %>% 
  filter(
    !is.na(biome)
  ) %>% 
  # select(INDEX,Model,time_period,MCP_Chng,Region,Outcome)
  # group_by(Model,RCP,time_period,Region,Geo_Region,Outcome) %>% 
  group_by(Model,RCP,time_period,Region,biome,Outcome) %>% 
  summarise(
    Count = n()
  ) %>% 
  filter(
    !biome %in% c("C_Polar_N","O_Polar_N"), # does not contain MPAs
    Region != "Open"
  ) %>% 
  spread(Outcome,Count)

# Double check
unique(Delta_Time_chi$biome)


### Chi-sqr test for all
mpa_chi_data <- Delta_Time_chi %>% 
  filter(Region != "Open") %>% 
  group_by(time_period,
           RCP,
           Region,
           # Geo_Region
           biome
  ) %>% 
  mutate(Level = paste(biome,Region,RCP,time_period,sep="")) %>%
  ungroup() %>% 
  dplyr::select(Negative:Level) %>% 
  group_by(Level) %>% 
  do(tidy(chisq.test(c(.$Negative, .$Positive))))

# Save data for Supplemental table S2
write.csv(mpa_chi_data,
          "TableS2.csv",
          row.names = F)
  
# Get Total numbers

Delta_Time_chi %>% 
  group_by(biome) %>% 
  summarise(
    sum(Negative,Positive)
  )
```


## 6.4 Comparisons between models

In here we compared the differences in abundance and MCP between the fish and MPA models to see if they perform differently under climate change

```{r stats_results_models, eval = F, echo = T}

Delta_Models <- autocor_data %>% 
  spread("Model","total") %>% 
  left_join(MPA_Grid,
            by= "INDEX") %>%  # 1 mpa ; 2 touching
  filter(Measure == "Mean",
         ! Data_Type %in% c("flexibility","nonuse_value"),
         !is.na(Touching),
         RCP == 85
  ) %>% 
  # Note; change the Distance filter to incorporate the non-sig to the discussion
  mutate(Region = ifelse(Touching == 0 & Distance <= 7.5,"Unprotected", # to find non-sig. 
                         ifelse(Touching == 1, "MPA",
                                ifelse(Touching == 2, "Surrounding", NA
                                )
                         )
  )
  ) %>% 
  group_by(time_period,
           Data_Type,
           Region
  ) %>% 
  # Uses broom to estimate sig.dif with wilcox for each group_by
  do(Wilcox = wilcox.test(.$Fish, .$MPA)) %>% 
  tidy(Wilcox)
  

write.csv(Delta_Models,
          "/nfs/mpasandclimatechange-data/Global Paper/Paper_Results/Stats_Data_models.csv",
          row.names = F)


Delta_Models %>% 
  # gather("Model","total",Fish:MPA) %>% 
  filter(
    time_period == "Mid Century",
    Data_Type == "Abd",
    RCP == 85,
    Measure == "Mean"
  ) %>% 
  ggplot() +
  geom_tile(
    aes(
      x = Longitude,
      y = Latitude,
      fill = MPA
    )
  )

```

## 6.5 Latitudinal relation
Here we used a linear model to observe how the differences between models change with latitude. 

```{r latitudinal_spillover, eval = F, echo = T}

# Abundance LM MPA

LM_Data_MPA <- autocor_data %>% 
  mutate(Abs_Latitude = abs(Latitude)) %>% 
  filter(
    Data_Type == "Biomass",
    Measure == "Mean",
    Touching_b == "MPA",
    time_period == "Mid Century",
    RCP == 85,
    Diff_Models != 0)

LM_MPA  <- lm(LM_Data_MPA$Abs_Latitude~LM_Data_MPA$Diff_Models)
summary(LM_MPA)

plot(LM_Data$Abs_Latitude~LM_Data$Diff_Models)


# Abundance LM Touching

LM_Data_Abd <- autocor_data %>% 
  mutate(Abs_Latitude = abs(Latitude)) %>% 
  filter(
    Data_Type == "Biomass",
    Measure == "Mean",
    Touching_b == "Surrounding",
    time_period == "Mid Century",
    RCP == 85,
    Diff_Models != 0)

LM_Abd_T  <- lm(LM_Data_Abd$Abs_Latitude~LM_Data_Abd$Diff_Models)
summary(LM_Abd_T)

plot(LM_Data_Abd$Abs_Latitude~LM_Data_Abd$Diff_Models)


# Revenue LM

LM_Data_Rev <- autocor_data %>% 
  mutate(Abs_Latitude = abs(Latitude)) %>% 
  filter(
    Data_Type == "Revenue",
    Measure == "Mean",
    Touching_b == "Surrounding",
    time_period == "Mid Century",
    RCP == 85,
    Diff_Models != 0)

LM_Rev  <- lm(LM_Data_Rev$Abs_Latitude~LM_Data_Rev$Diff_Models)
summary(LM_Rev)

plot(LM_Data_Rev$Abs_Latitude~LM_Data_Rev$Diff_Models)


# Abundance LM Oppen

LM_Data_Open <- autocor_data %>% 
  mutate(Abs_Latitude = abs(Latitude)) %>% 
  filter(
    Data_Type == "Biomass",
    Measure == "Mean",
    Touching_b == "Unprotected",
    time_period == "Mid Century",
    RCP == 85,
    Diff_Models != 0)

LM_One_Open  <- lm(LM_Data_Open$Abs_Latitude~LM_Data_Open$Diff_Models)
summary(LM_One_Open)

plot(LM_Data_Open$Abs_Latitude~LM_Data_Open$Diff_Models)


```

## 6.6 Mean and SD stats 

Averages and s.d. for the results section

```{r stats_mean_change, eval = F, echo = T}

# Get mean +- sd of change 
Delta_time_mpa_level <- Delta_Time %>% 
  filter(Model == "MPA" & Data_Type == "Abd") %>% 
  group_by(time_period,RCP,NAME,REP_M_AREA,ISO3) %>% 
  summarize(mean_chng = mean(MCP_Chng, na.rm = T),
            sd_chng = sd(MCP_Chng, na.rm = T),
            n = n())
```

# 7 Sensitivity Analysis

We need to test the sensitivity of the larvae fix parameters of the DBEM. There are three main components:

- *DiffCoef*, which talks about each species diffusion rate, 
- *LarSurv* = 0.15, determines the larval survival,
- *rLarSettle* = 0.15, determines the larval settlement rate

We will run the DBEM in compu-Canada 4 times (2 increasing and 2 decreasing) for each variable and model (Fish and MPA), for a total of 40 random species using the GFDL85 from 1995 to 2014 (today) as follows:

- *DiffCoef*, -0.10; -0.20; +0.10; +0.20
- *LarSurv* = 0.15, 0.5; 0.10; 0.20; 0.25
- *rLarSettle* = 0.15, 0.5; 0.10; 0.20; 0.25

At the end we can produce histograms and to see if there are differences between variables.

## 7.1 Choosing the species

```{r Choose_Species, eval = F, echo = T}

# Functions needed to get species

source(here::here("DBEM/Functions_Paper2/Get_Spp_Grid.r")) # Chagos grid for species there
source("./DBEM/Functions/DBEM_imp_F.r") # Imports a single species

# Data needed to get species
Chagos_Grid <- fread("/nfs/mpasandclimatechange-data/Data/MPA/grid_MPA_touching.csv",header = TRUE) %>%
  filter(NAME == "British Indian Ocean Territory Marine Protected Area (Chagos)") %>% 
  rename(INDEX = Seq) %>% 
  select(INDEX, NAME)

# Get taxon list from what we've modeled so far
Taxon_List <- inner_join(mpa_model_species, fish_model_species) %>% pull(x)

# Get species list for sensitivity analysis using the GFDL 26

# Global Variables
RCP = "26"
Model <- "Fish"
Initial_Y = 1995
Final_Y = 2014
GCM = "GFDL26"
# Run function Get_Spp_Grid
sensitivity_spp <- bind_rows(lapply(Taxon_List, FUN=Get_Spp_Grid, Chagos_Grid))


selected_sensitivity_spp <- slice(sensitivity_spp, sample(1:40)) %>% 
  select(TaxonKey)

readr::write_csv(selected_sensitivity_spp,
          "RunSppListSen10.txt")
sample(c(0,1), 100, replace = TRUE)

# Send RunSppListSen10.txt to computeCanada over terminal

```

## 7.2 Sensitivity Results

```{r Sens_Results, eval = F, echo = T}

# Load Data need
MPA_Grid <- fread("/nfs/mpasandclimatechange-data/Data/MPA/grid_MPA_touching.csv",header = TRUE) %>% 
  # filter(NAME == "British Indian Ocean Territory Marine Protected Area (Chagos)") %>% 
  rename(INDEX = Seq) %>% 
  select(INDEX, NAME,Touching)

# Load Sensitivity analysis data
Fish_Sen <- fread("/nfs/mpasandclimatechange-data/Data/Results/Sensitivity/Sensitivity_Fish.csv")

mean(Fish_Sen$total)
max(Fish_Sen$total)


MPA_Sen <- fread("/nfs/mpasandclimatechange-data/Data/Results/Sensitivity/Sensitivity_MPA.csv")

max(MPA_Sen$total)
mean(MPA_Sen$total)


# Estimate the percentage change

Sens_PerChange <- Sen_Data %>% 
  filter(
    Data_Type %in% c("Abd"),
    Measure == "Mean"
  ) %>% 
  select(-n) %>% 
  spread("Model","total") %>% 
  mutate(
    MPA = ifelse(is.na(MPA), 0, MPA), # I believe there are parts that MPA model does not have?
    Fish = ifelse(is.na(Fish), 0, Fish),
    Diff_Models = ifelse(MPA == 0 & Fish == 0, 0, # If MPA and Fish are zero, then no change
                         ifelse(MPA == 0 & Fish > 0, -100, # If MPA is zero but Fish >0 then -100 
                                ifelse(MPA > 0 & Fish == 0, 100, # If MPA > 0 but Fish = 0, then +100
                                       ((MPA-Fish)/((MPA+Fish)/2))*100
                                )
                         )
    ),
    # Just to set the percentage bounds
    Per = ifelse(Diff_Models <= -25, -25,
                 ifelse(Diff_Models >= 25, 25,Diff_Models)
    ),
    # For plot labels
    # Data_Type = ifelse(Data_Type == "Abd","Biomass","Revenue")
  ) %>% 
  left_join(MPA_Grid,
            by = "INDEX") %>% 
  mutate(
    Touching_b = ifelse(Touching == 0,"Unprotected",
                        ifelse(Touching == 1, "MPA",
                               ifelse(Touching == 2, "Surrounding",
                                      NA
                               )
                        )
    )
  )





max(Sens_PerChange$Diff_Models)
min(Sens_PerChange$Diff_Models)
```

# 8. Supplemental material

## Fig. S1.Variogram

```{r variogram, eval = T, echo = F}
# plot(plot_data)

ggplot() +
  geom_point(data = partial,
             aes(
               x = dist,
               y = variog#,
               # color = run
             ),
             alpha = 0.5
  ) +
  geom_smooth(data = plot_data,
              aes(
                x = dist,
                y = variog,
              ),
              method = "gam",
              alpha = 0.5
  ) +
  geom_point(data = means_data,
             aes(
               x = dist_mean,
               y = variog_mean#,
               # fill = n.pairs_mean
             ),
             size = 1,
             fill = "red",
             color = "red"
  ) +
  ggtheme_Plot() +
  ylab("Variogram") +
  xlab("Distance (Km)") +
  ggsave(
    plot = last_plot(),
    width = 8,
    height = 6,
    units = "in",
    filename = "Variogram.png",
    path= "./data/Global Paper/Submission_GCB/Supplements/"
  )

```

## Fig. S2.Larvae sens.

```{r Sens_Figures, eval = F, echo = T}

Sens_PerChange %>% 
  filter(Touching == 2 & Per > 0 & Per < 25) %>% 
  ungroup() %>% 
  mutate(
    Sen =  ifelse(Sen == "Sur","Survival",
                  ifelse(Sen == "Set","Settlement","Diffusion")
                  )
  ) %>% 
  ggplot() +
  geom_histogram(
    aes(
      x = Per
    ),
    bins = 100
  ) +
  facet_wrap(~Sen+Coef,
             scales = "free") +
  labs(x = "Differences between models (%)",
       y = "Frequency") +
  ggtheme_Plot()

 ggsave(
    plot = last_plot(),
    width = 14,
    height = 10,
    units = "in",
    # filename = "larvae_sensitivity.png",
    # path=  "./data/Data/Results/Sensitivity"
    # Info for final plots 
    filename ="Figure4.png",
    path = "/nfs/mpasandclimatechange-data/Global Paper/Submission_NCC/Figures/"
  )


```

## Fig S3. Delta time for all

Fig S3. Change in biomass under climate change, incorporating current no-take MPAs.** Results for mid (2041-2060) and end (2081-2099) century in reference to present (1995-2014) under a low (RCP 2.6) and high emission scenario (RCP 8.5). Results from the MPA model with MPAs included in this study outlined in black.


```{r Fig_sone_plot, eval = F, echo = T}

# Convert data to projected shapefile
Delta_time_map <- Delta_Time %>% 
  filter(Model == "MPA" & Data_Type == "Abd" )

Delta_time_map <- st_as_sf(Delta_time_map,
                           coords = c("Longitude", "Latitude")
) %>%
  st_set_crs(4326) %>% # to match shapefiles
  st_transform("+proj=eck4")


ggplot() +
  geom_sf(data = Delta_time_map, aes(colour = Per)) +
  geom_sf(data = World_Land_sf, colour = "grey50", fill = "grey50") +
  geom_sf(data = MPA_sf, colour = "black", fill = NA, size = 0.5) +
  scale_colour_gradient2("Percentage Change in Biomass (%)",
                       labels = c("<-25",seq(-20,20,5),">25"),
                       breaks = c(seq(-25,25,5)),
                       na.value = "grey90"
  ) +
  ggtheme_Map() +
  guides(fill = guide_legend(title.position = "top",
                             label.position = "bottom",
                             title.hjust = 0.5,
                             nrow = 1,
                             byrow = TRUE)
  ) +
  facet_wrap(~time_period + RCP,
             ncol= 2) +
  ggsave(
    width = 12,
    height = 7,
    units = "in",
    # filename = "Figure_1_20_NewB.png",
    # path= "./data/Global Paper/Paper_Results"
    # Path and name for submission
    filename = "FigureS3.png",
    path= "./data/Global Paper/Submission_GCB/Supplements"
  )


```

## Fig. S4 - Supplemental

This is the same figure as Figure 3. But for the end of the century

```{r Fig_S4_Supplemental, eval = F, echo = T}

# --------------------- #
# Create maps (A and B)
# --------------------- #

# Abundance Map
Map_Abd <- Results_Data_map %>% 
  filter(
    Data_Type == "Biomass" & time_period == "End of Century"
  ) %>% 
  ggplot() +
  geom_sf(aes(color = Per)) +
  geom_sf(data = World_Land_sf, colour = "grey50", fill = "grey50") +
  scale_colour_gradient2("Change realtive to present (%)",
                         labels = c("<-25",seq(-20,20,5),">25"),
                         breaks = c(seq(-25,25,5)),
                         na.value = "grey90"
  ) +
  ggtheme_Map() +
  theme(legend.position = "")
  

# Revenue Map

Map_Rev <- Results_Data_map %>% 
  filter(
    Data_Type == "Revenue" & time_period == "End of Century"
  ) %>% 
  ggplot() +
  geom_sf(aes(color = Per)) +
  geom_sf(data = World_Land_sf, colour = "grey50", fill = "grey50") +
  scale_colour_gradient2("Change realtive to present (%)",
                         labels = c("<-25",seq(-20,20,5),">25"),
                         breaks = c(seq(-25,25,5)),
                         na.value = "grey90"
  ) +
  ggtheme_Map() +
  theme(legend.position = "")+
  ggtheme_Map() +
  guides(fill = guide_legend(title.position = "top",
                             label.position = "bottom",
                             title.hjust = 0.5,
                             nrow = 1,
                             byrow = TRUE)
  )


# Get legend for cowplot
legend_map <- get_legend(Map_Rev)

# Re-plot without legend
Map_Rev <- Map_Rev +
  theme(legend.position = "")

# --------------------- #
# Create histograms (C)
# --------------------- #

# Abundance Histogram (No Latitudinal differentiation)

Hist_Abd <- ggplot() + 
  geom_path(data = subset(Spillover_diff_Lat, Data_Type == "Biomass" & time_period == "End of Century"), 
            aes(y=Latitude, 
                x=total_value, 
                color=Touching_b),
            size = 1) +
  geom_path(data = subset(Spillover_diff_Lat_1, Data_Type == "Biomass" & time_period == "End of Century"),
            aes(y=Latitude, 
                x=total_value, 
                color = "Total"),
            size = 1
            ) +
  scale_color_manual(values = wes_palette("Darjeeling2")) +
  scale_x_continuous(breaks = 0) +
  # scale_color_manual(values=c("dodgerblue3", "firebrick3", "black", "seagreen3"))+
  ggtheme_Plot() +
  labs(x = "",
       y = "") +
  theme(
  axis.text.y = element_blank(),
  legend.position = "",
  legend.key.width = unit(2,"line"),
  legend.title = element_text(size = 22),
  legend.text = element_text(size = 20)
  ) +
  geom_vline(xintercept = 0, colour = "black", linetype = "dotted") 


Hist_Rev <- ggplot() + 
  geom_path(data = subset(Spillover_diff_Lat, Data_Type == "Revenue" & time_period == "End of Century"), 
            aes(y=Latitude, 
                x=total_value, 
                color=Touching_b),
            size = 1)  +
  geom_path(data = subset(Spillover_diff_Lat_1, Data_Type == "Revenue" & time_period == "End of Century"),
            aes(y=Latitude, 
                x=total_value, 
                color = "Total"), 
            # linetype = "dotted",
            size = 1) +
  geom_vline(xintercept = 0, colour = "black",linetype = "dotted") +
  scale_color_manual("Spillover effect by latitude",
                     values = wes_palette("Darjeeling2")
  ) +
  scale_x_continuous(breaks = 0) +
  # scale_color_manual(values=c("dodgerblue3",
  #                             "firebrick3",
  #                             "black",
  # "seagreen3"))+
  ggtheme_Plot() +
  labs(x = "",
       y = "") +
  theme(
    axis.text.y = element_blank(),
    legend.position = "bottom",
    legend.title = element_text(size = 22),
    legend.text = element_text(size = 20)
  ) +
  guides(color = guide_legend(title.position = "top",
                              label.position = "right",
                              title.hjust = 0.5,
                              nrow = 1,
                              byrow = TRUE)
  )

# Get legend for cowplot
legend_hist <- get_legend(Hist_Rev)

# Re-plot without legend
Hist_Rev <- Hist_Rev +
  theme(legend.position = "")

# --------------------- #
# Plot them all
# --------------------- #

plot <- ggdraw() +
  # Abundance
  draw_plot(Map_Abd, x = 0, y = 0.6, width = 0.6, height = 0.4) +
  draw_plot(Hist_Abd, x = 0.59, y = 0.59, width = 0.3, height = 0.4) +
  # Revenue
  draw_plot(Map_Rev, x = 0, y = 0.2, width = 0.6, height = 0.4) +
  draw_plot(Hist_Rev, x = 0.57, y = 0.19, width = 0.3, height = 0.4) +
  # Legends
  draw_plot(legend_map, x = 0, y = 0.1, width = 0.59, height = 0.1) +
  draw_plot(legend_hist, x = 0.60, y = 0.1, width = 0.3, height = 0.1) +
  # Labeks
  draw_plot_label(label = c("A", "B", "C"), 
                  size = 30,
                  x = c(0.0, 0.0, 0.56), 
                  y = c(1, 0.6, 1)
  ) +
  # Uncomment for latitudinal version 
  draw_plot_label(label = c("Revenue", "Abundance"),
                  size = 40,
                  x = c(0.91, 0.91),
                  y = c(0.50, 1),
                  angle = 270,
                  colour = "black"
  )

# Path and name for submission
# Save plot 
save_plot("./data/Global Paper/Submission/Figures/FigureS2.png",
          plot,
          base_height = 15,
          base_width = 20)

```
